require "bundler/capistrano"

set :application, "<%= ENV['APP_NAME']%>"

set :repository, "."
set :scm, "none"
set :deploy_via, :copy
set :copy_exclude, ["/.git/", "/.gitignore", "/db/*.sqlite3", "/log/*.log", "/tmp"]
set :copy_remote_dir, "/srv/#{application}/tmp"
set :deploy_to, "/srv/#{application}"
set :user, "#{application}"
set :use_sudo, false
set :group_writable, false

task :staging do
  server "localhost", :web, :app, :db, :primary => true
end

task :production do
  server "<%= `hostname -f`.chomp %>", :web, :app, :db, :primary => true
end

namespace :deploy do
  after "deploy:restart", "deploy:cleanup"

  desc "Copy config files to deployed version."
  task :copy_config, :roles => :app, :except => { :no_release => true } do
    run "cp -a #{shared_path}/config/* #{release_path}/config"
  end

  after "deploy:update_code", "deploy:copy_config"

  desc "Restart the application servers."
  task :restart, :roles => :app, :except => { :no_release => true } do
    sudo "systemctl reload unicorn@#{application}.service"
  end
end
