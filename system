sgdisk -Z -a 2048 -o -g -n 1:2048:+1M -t 1:ef02 -n 2::+512M -N 3 -p /dev/sda

mkfs.ext4 -L boot /dev/sda2

cryptsetup luksFormat /dev/sda3 && cryptsetup luksOpen /dev/sda3 root && mkfs.ext4 -L root /dev/mapper/root

mount LABEL=root /mnt && mkdir /mnt/boot && mount LABEL=boot /mnt/boot

echo 'Server = http://mirrors.kernel.org/archlinux/$repo/os/$arch' > /etc/pacman.d/mirrorlist

pacstrap /mnt base base-devel python2 ruby grub openssh \
	rsync tmux vim zsh git nmap socat traceroute dnsutils whois pwgen

genfstab -p -L /mnt > /mnt/etc/fstab

arch-chroot /mnt

echo 'darwin' > /etc/hostname

ln -s -r /usr/share/zoneinfo/UTC /etc/localtime

sed -i -r -e "/^#$LANG/s/^#//" /etc/locale.gen && locale-gen

echo "LANG=$LANG" > /etc/locale.conf

sed -i -e '/^HOOKS=/s/filesystems/encrypt filesystems/' /etc/mkinitcpio.conf

mkinitcpio -p linux

echo 'Defaults !env_reset' | (umask 0227 && cat > /etc/sudoers.d/98env_keep)
echo '%wheel ALL=(ALL) NOPASSWD: ALL' | (umask 0227 && cat > /etc/sudoers.d/99root)

useradd -G users,wheel -m -s /usr/bin/zsh igor && passwd igor

passwd -l root

systemctl enable sshd.service

export IF_NAME=`ip route show | awk '/^default/ { print $5 }'`
export IF_ADDRESS=`ip addr show ${IF_NAME} | awk '/inet[^6]/ { print $2 }'`
export IF_ROUTE=`ip route show | awk '/^default/ { print $3 }'`

cat << EOF > /etc/systemd/network/static.network
[Match]
Name=${IF_NAME}

[Network]
Address=${IF_ADDRESS}
Gateway=${IF_ROUTE}
EOF

systemctl enable systemd-networkd.service systemd-timesyncd.service

grub-install /dev/sda

ln -s -r /boot/grub/locale/en{\@quot,}.mo

sed -i -e '/^GRUB_CMDLINE_LINUX=/s/""/"cryptdevice=\/dev\/sda3:root"/' /etc/default/grub
sed -i -e '/^#GRUB_DISABLE_LINUX_UUID=/s/^#//' /etc/default/grub

grub-mkconfig -o /boot/grub/grub.cfg

exit

umount /mnt/{boot,}
