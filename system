echo -e "2,512\n514" | sfdisk -uM --quiet /dev/sda

mkfs.ext4 -L boot /dev/sda1

<% if encrypt %>
cryptsetup luksFormat /dev/sda2 && cryptsetup luksOpen /dev/sda2 root && mkfs.ext4 -L root /dev/mapper/root
<% else %>
mkfs.ext4 -L root /dev/sda2
<% end %>

udevadm settle

mount /dev/disk/by-label/root /mnt && mkdir /mnt/boot && mount /dev/disk/by-label/boot /mnt/boot

echo 'Server = http://mirrors.kernel.org/archlinux/$repo/os/$arch' > /etc/pacman.d/mirrorlist

pacstrap /mnt base base-devel python2 ruby grub-bios ntp openssh \
	sudo rsync tmux vim zsh git nmap socat traceroute dnsutils whois pwgen

echo -e "/dev/disk/by-label/root\t/\text4\tdefaults\t1\t1" > /mnt/etc/fstab
echo -e "/dev/disk/by-label/boot\t/boot\text4\tdefaults\t1\t2" >> /mnt/etc/fstab

cp -a /etc/resolv.conf /mnt/etc

arch-chroot /mnt

sed -i -r -e "/^#$LANG/s/^#//" /etc/locale.gen && locale-gen

echo "LANG=$LANG" > /etc/locale.conf

<% if encrypt %>
sed -i -e '/^HOOKS=/s/filesystems/encrypt filesystems/' /etc/mkinitcpio.conf
<% end %>

mkinitcpio -p linux

ln -s -r /usr/share/zoneinfo/UTC /etc/localtime

echo 'darwin' > /etc/hostname

cat << EOF > /etc/netctl/static
Description='A basic static ethernet connection'
Interface=eth0
Connection=ethernet
IP=static
Address=('192.168.1.2/24')
Gateway='192.168.1.1'
DNS=('8.8.8.8' '8.8.4.4')
EOF

netctl enable static

systemctl enable {cronie,ntpd,sshd}.service

echo 'Defaults !env_reset' | (umask 0227 && cat > /etc/sudoers.d/98env_keep)
echo '%wheel ALL=(ALL) NOPASSWD: ALL' | (umask 0227 && cat > /etc/sudoers.d/99root)

useradd -G users,wheel -m -s /bin/zsh igor && passwd igor

passwd -l root

echo 'export EDITOR=vim' > /etc/profile.d/editor.sh && chmod +x /etc/profile.d/editor.sh

grub-install /dev/sda

ln -s -r /boot/grub/locale/en{\@quot,}.mo

<% if encrypt %>
sed -i -e '/^GRUB_CMDLINE_LINUX=/s/""/"cryptdevice=\/dev\/sda2:root"/' /etc/default/grub
<% end %>

sed -i -e '/^#GRUB_DISABLE_LINUX_UUID=/s/^#//' /etc/default/grub

grub-mkconfig -o /boot/grub/grub.cfg

exit

umount /mnt/{boot,}
