ntpdate pool.ntp.org

sgdisk -Z -a 2048 -o -g -n 1:2048:+1M -t 1:ef02 -n 2::+512M -N 3 -p /dev/sda

cryptsetup luksFormat /dev/sda3 && cryptsetup luksOpen /dev/sda3 root

mkfs.ext4 /dev/sda2 && mkfs.ext4 /dev/mapper/root

mount /dev/mapper/root /mnt && mkdir /mnt/boot && mount /dev/sda2 /mnt/boot

pacstrap /mnt base base-devel python2 ruby grub ntp openssh \
	rsync tmux vim zsh git tcpdump nmap socat traceroute bind-tools whois pwgen \
	open-vm-tools

genfstab -U /mnt > /mnt/etc/fstab

arch-chroot /mnt /bin/zsh

git clone https://github.com/zynaps/setup.git /tmp/setup

ln -s /usr/share/zoneinfo/UTC /etc/localtime

sed -i -r -e "/^#$LANG/s/^#//" /etc/locale.gen && locale-gen

echo "LANG=$LANG" > /etc/locale.conf

echo 'darwin' > /etc/hostname

sed -i -e '/^HOOKS=/s/filesystems/encrypt filesystems/' /etc/mkinitcpio.conf

mkinitcpio -p linux

echo '%wheel ALL=(ALL) NOPASSWD: ALL' | (umask 0227 && cat > /etc/sudoers.d/99root)

useradd -G users,wheel -m -s /bin/zsh igor && passwd igor
mkdir -m 700 -p ~igor/.ssh && install -m 600 /tmp/setup/files/authorized_keys ~igor/.ssh
chown -R igor:igor ~igor/.ssh

passwd -l root

echo -e "\n# A clock offset of any value will be accepted\ntinker panic 0" >> /etc/ntp.conf

sed -i -r -e '/^#?PasswordAuthentication/cPasswordAuthentication no' /etc/ssh/sshd_config

systemctl enable {ntpd,sshd}.service vmtoolsd.service

export IF_NAME=`ip -4 route show to default | awk '{ print $5 }'`
export IF_ADDRESS=`ip -4 -o addr show ${IF_NAME} | awk '{ print $4 }'`
export IF_ROUTE=`ip -4 route show to default | awk '{ print $3 }'`

cat << EOF > /etc/netctl/static
Description='A basic static ethernet connection'
Interface='${IF_NAME}'
Connection=ethernet
IP=static
Address=('${IF_ADDRESS}')
Gateway='${IF_ROUTE}'
DNS=('8.8.8.8' '8.8.4.4')
DNSDomain='zynaps.ru'
EOF

netctl enable static

grub-install /dev/sda
sed -i -e '/^GRUB_CMDLINE_LINUX=/s/"$/ cryptdevice=\/dev\/sda3:root"/' /etc/default/grub
grub-mkconfig -o /boot/grub/grub.cfg

exit

umount -R /mnt
