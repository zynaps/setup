ntpdate pool.ntp.org

sgdisk -Z -a 2048 -o -g -n 1:2048:+1M -t 1:ef02 -n 2::+512M -N 3 -p /dev/sda

cryptsetup luksFormat /dev/sda3 && cryptsetup luksOpen /dev/sda3 root

mkfs.ext4 /dev/sda2 && mkfs.ext4 /dev/mapper/root

mount /dev/mapper/root /mnt && mkdir /mnt/boot && mount /dev/sda2 /mnt/boot

pacstrap /mnt base base-devel python2 ruby grub ntp openssh htop lsof \
	rsync tmux vim zsh git tcpdump nmap iperf3 socat traceroute bind-tools whois pwgen \
	open-vm-tools

genfstab -U /mnt > /mnt/etc/fstab

arch-chroot /mnt /bin/zsh

hwclock --systohc

sed -i -r -e "/^#${LANG}/s/^#//" /etc/locale.gen && locale-gen

echo "LANG=${LANG}" > /etc/locale.conf

echo 'darwin' > /etc/hostname

export IF_NAME=`ip -4 route show to default | awk '{ print $5 }'`
export IF_ADDRESS=`ip -4 -o addr show ${IF_NAME} | awk '{ print $4 }'`
export IF_ROUTE=`ip -4 route show to default | awk '{ print $3 }'`

cat << EOF > /etc/netctl/static
Description='A basic static ethernet connection'
Interface='${IF_NAME}'
Connection=ethernet
IP=static
Address=('${IF_ADDRESS}')
Gateway='${IF_ROUTE}'
DNS=('8.8.8.8' '8.8.4.4')
DNSDomain='zynaps.ru'
EOF

netctl enable static

systemctl enable {ntpdate,ntpd,sshd}.service vmtoolsd.service

sed -i -e '/^HOOKS=/s/filesystems/encrypt filesystems/' /etc/mkinitcpio.conf

mkinitcpio -p linux

echo '%wheel ALL=(ALL) NOPASSWD: ALL' | (umask 0227 && cat > /etc/sudoers.d/99_wheel_nopasswd)

useradd -G users,wheel -m -s /bin/zsh igor && passwd igor && passwd -l root

grub-install /dev/sda
sed -i -e '/^GRUB_CMDLINE_LINUX=/s/"$/ cryptdevice=\/dev\/sda3:root"/' /etc/default/grub
sed -i -e '/^GRUB_CMDLINE_LINUX=/s/"$/ transparent_hugepage=never"/' /etc/default/grub
grub-mkconfig -o /boot/grub/grub.cfg

exit

umount -R /mnt
