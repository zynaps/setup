ntpdate pool.ntp.org

sgdisk -Z -a 2048 -o -g -n 1:2048:+1M -t 1:ef02 -n 2::+512M -N 3 -p /dev/sda

cryptsetup luksFormat /dev/sda3 && cryptsetup luksOpen /dev/sda3 root

mkfs.ext4 /dev/sda2 && mkfs.ext4 /dev/mapper/root

mount /dev/mapper/root /mnt && mkdir /mnt/boot && mount /dev/sda2 /mnt/boot

mv /etc/pacman.d/mirrorlist /etc/pacman.d/mirrorlist.orig
curl -Ssf -L -o /etc/pacman.d/mirrorlist \
  'https://www.archlinux.org/mirrorlist/?protocol=http&use_mirror_status=on&country=RU'
sed -i -r -e '/^#?Server/s/^#//' /etc/pacman.d/mirrorlist

pacstrap /mnt \
    base pacman-contrib grub openssh ntp \
    base-devel python2 ruby ruby-rdoc ruby-bundler \
    traceroute tcpdump wireshark-cli nmap htop lsof iperf3 socat bind-tools whois \
    zsh tmux git vim rsync wget lftp pwgen bc

genfstab -U /mnt > /mnt/etc/fstab

systemd-firstboot --root=/mnt --hostname='darwin' --timezone='UTC' --locale=${LANG}

arch-chroot /mnt /bin/zsh

hwclock --systohc

echo "vm.overcommit_memory = 1" > /etc/sysctl.d/overcommit.conf
echo "net.ipv4.tcp_max_syn_backlog = 512" > /etc/sysctl.d/tcp_max_syn_backlog.conf
echo "net.core.somaxconn = 512" > /etc/sysctl.d/somaxconn.conf

sed -i -r -e "/^#${LANG}/s/^#//" /etc/locale.gen && locale-gen

export IF_NAME=`ip -4 route show to default | awk '{ print $5 }'`
export IF_ADDRESS=`ip -4 -o addr show ${IF_NAME} | awk '{ print $4 }'`
export IF_ROUTE=`ip -4 route show to default | awk '{ print $3 }'`

cat << EOF > /etc/netctl/static
Description='A basic static ethernet connection'
Interface='${IF_NAME}'
Connection=ethernet
IP=static
Address=('${IF_ADDRESS}')
Gateway='${IF_ROUTE}'
DNS=('8.8.8.8' '8.8.4.4')
DNSDomain='zynaps.ru'
EOF

netctl enable static

cp /etc/iptables/empty.rules /etc/iptables/iptables.rules

systemctl enable {iptables,ntpdate,ntpd,sshd}.service paccache.timer

case `systemd-detect-virt --vm` in
    vmware)
        pacman -S open-vm-tools
        systemctl enable vmtoolsd.service
    ;;
    oracle)
        pacman -S virtualbox-guest-utils-nox virtualbox-guest-modules-arch
        systemctl enable vboxservice.service
    ;;
    qemu)
        pacman -S qemu-guest-agent
        systemctl enable qemu-ga.service
    ;;
esac

sed -i -e '/^HOOKS=/s/filesystems/encrypt filesystems/' /etc/mkinitcpio.conf

mkinitcpio -p linux

echo '%wheel ALL=(ALL) NOPASSWD: ALL' | (umask 0227 && cat > /etc/sudoers.d/99_wheel_nopasswd)

useradd -G users,wheel -m -s /bin/zsh igor && passwd igor && passwd -l root

grub-install /dev/sda
sed -i -e '/^GRUB_CMDLINE_LINUX=/s/"$/ cryptdevice=\/dev\/sda3:root"/' /etc/default/grub
sed -i -e '/^GRUB_CMDLINE_LINUX=/s/"$/ transparent_hugepage=never"/' /etc/default/grub
grub-mkconfig -o /boot/grub/grub.cfg

exit

umount -R /mnt
