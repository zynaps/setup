sgdisk -Z -a 2048 -o -g -n 1:2048:+1M -t 1:ef02 -n 2::+512M -N 3 -p /dev/sda

mkfs.ext4 -L boot /dev/sda2

cryptsetup luksFormat /dev/sda3 && cryptsetup luksOpen /dev/sda3 root && mkfs.ext4 -L root /dev/mapper/root

mount LABEL=root /mnt && mkdir /mnt/boot && mount LABEL=boot /mnt/boot

echo 'Server = http://mirrors.kernel.org/archlinux/$repo/os/$arch' > /etc/pacman.d/mirrorlist

pacstrap /mnt base base-devel python2 ruby grub ntp openssh \
	rsync tmux vim zsh git nmap socat traceroute dnsutils whois pwgen

genfstab -p -L /mnt > /mnt/etc/fstab

cp -a /etc/resolv.conf /mnt/etc

arch-chroot /mnt

echo 'darwin' > /etc/hostname

ln -s -r /usr/share/zoneinfo/UTC /etc/localtime

sed -i -r -e "/^#$LANG/s/^#//" /etc/locale.gen && locale-gen

echo "LANG=$LANG" > /etc/locale.conf

sed -i -e '/^HOOKS=/s/filesystems/encrypt filesystems/' /etc/mkinitcpio.conf

mkinitcpio -p linux

echo 'Defaults !env_reset' | (umask 0227 && cat > /etc/sudoers.d/98env_keep)
echo '%wheel ALL=(ALL) NOPASSWD: ALL' | (umask 0227 && cat > /etc/sudoers.d/99root)

useradd -G users,wheel -m -s /usr/bin/zsh igor && passwd igor

passwd -l root

cat << EOF > /etc/netctl/static
Description='A basic static ethernet connection'
Interface=eth0
Connection=ethernet
IP=static
Address=('192.168.1.2/24')
Gateway='192.168.1.1'
DNS=('8.8.8.8' '8.8.4.4')
DNSSearch='zynaps.ru'
EOF

netctl enable static

grub-install /dev/sda

ln -s -r /boot/grub/locale/en{\@quot,}.mo

sed -i -e '/^GRUB_CMDLINE_LINUX=/s/""/"cryptdevice=\/dev\/sda3:root"/' /etc/default/grub
sed -i -e '/^#GRUB_DISABLE_LINUX_UUID=/s/^#//' /etc/default/grub

grub-mkconfig -o /boot/grub/grub.cfg

systemctl enable {ntpd,sshd}.service

exit

umount /mnt/{boot,}
