pacman -S postgresql
PWFILE=`mktemp` && pwgen -A1Bn 16 > ${PWFILE} && chown postgres:postgres ${PWFILE}
chown -R postgres:postgres /var/lib/postgres
sudo -i -u postgres initdb -A md5 --pwfile=${PWFILE} /var/lib/postgres/data
sed -i -e 's/^/*:*:*:postgres:/' ${PWFILE} && mv ${PWFILE} /root/.pgpass && chown root:root /root/.pgpass
systemctl enable postgresql.service

pacman -S redis
echo "vm.overcommit_memory = 1" > /etc/sysctl.d/overcommit.conf
echo "net.ipv4.tcp_max_syn_backlog = 512" > /etc/sysctl.d/tcp_max_syn_backlog.conf
echo "net.core.somaxconn = 512" > /etc/sysctl.d/somaxconn.conf
systemctl enable redis.service

pacman -S nginx
mkdir -p /etc/nginx/sites.d
install -m 644 /tmp/setup/files/nginx.conf /etc/nginx
systemctl enable nginx.service

GEM_HOME=`ruby -rubygems -e "puts Gem.default_dir"` gem install bundler --no-user-install

install -m 644 /tmp/setup/files/unicorn@.service /etc/systemd/system

install -m 644 /tmp/setup/files/resque_scheduler@.service /etc/systemd/system

install -m 644 /tmp/setup/files/resque_workers@.service /etc/systemd/system

pacman -S gitolite
cp /tmp/setup/files/authorized_keys /var/lib/gitolite/zynaps.pub
sudo -i -u gitolite gitolite setup -pk zynaps.pub
rm /var/lib/gitolite/zynaps.pub
