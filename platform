pacman -S postgresql
mkdir -p /var/lib/postgres && chown -R postgres:postgres /var/lib/postgres
PWFILE=`mktemp` && pwgen -A1Bn 16 > ${PWFILE} && chown postgres:postgres ${PWFILE}
sudo -i -u postgres initdb -A md5 --pwfile=${PWFILE} /var/lib/postgres/data
sed -i -e 's/^/*:*:*:postgres:/' ${PWFILE} && mv ${PWFILE} /root/.pgpass && chown root:root /root/.pgpass
systemctl enable postgresql.service

pacman -S mongodb
sed -i -e '/^DAEMONS=/s/)$/ mongodb)/' /etc/rc.conf

pacman -S redis
echo "vm.overcommit_memory = 1" > /etc/sysctl.d/overcommit.conf
sed -i -e '/^loglevel/s/verbose$/notice/' /etc/redis.conf
sed -i -e '/^DAEMONS=/s/)$/ redis)/' /etc/rc.conf

pacman -S erlang

sudo -i -u ${SUDO_USER}
cd `mktemp -d`
curl https://aur.archlinux.org/packages/ra/rabbitmq/rabbitmq.tar.gz -o - | tar zxf - --strip-components=1
makepkg -s -c -i
exit
echo '[].' > /etc/rabbitmq/enabled_plugins && chown rabbitmq:rabbitmq /etc/rabbitmq/enabled_plugins
rabbitmq-plugins enable rabbitmq_management
sed -i -e '/^DAEMONS=/s/)$/ rabbitmq-server)/' /etc/rc.conf

sudo -i -u ${SUDO_USER}
cd `mktemp -d`
cp -a /tmp/setup/builds/nginx/* .
makepkg -s -c -i
exit
sed -i -e '/^DAEMONS=/s/)$/ nginx)/' /etc/rc.conf

pacman -S ruby
sed -i -e '/^gem:/s/--user-install/--no-user-install/' /etc/gemrc
gem update --system && gem update

echo 'export RUBYOPT=-Ku' > /etc/profile.d/rubyopt.sh && chmod +x /etc/profile.d/rubyopt.sh

gem install bundler

gem install god
mkdir -p /etc/god.d
echo 'God.load "/etc/god.d/**/*.god"' > /etc/god.conf
echo 'GOD_ARGS="-c /etc/god.conf"' > /etc/conf.d/god
install /tmp/setup/files/god.rc /etc/rc.d/god
sed -i -e '/^DAEMONS=/s/)$/ god)/' /etc/rc.conf

sudo -i -u ${SUDO_USER}
cd `mktemp -d`
curl https://aur.archlinux.org/packages/gi/gitosis-git/gitosis-git.tar.gz -o - | tar zxf - --strip-components=1
makepkg -s -c -i
exit
sudo -i -u git gitosis-init < /tmp/setup/files/authorized_keys
