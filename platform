pacman -S postgresql
PWFILE=`mktemp` && pwgen -A1Bn 16 > ${PWFILE} && chown postgres:postgres ${PWFILE}
chown -R postgres:postgres /var/lib/postgres
sudo -i -u postgres initdb -A md5 --pwfile=${PWFILE} /var/lib/postgres/data
sed -i -e 's/^/*:*:*:postgres:/' ${PWFILE} && mv ${PWFILE} /root/.pgpass && chown root:root /root/.pgpass
systemctl enable postgresql.service

pacman -S redis
echo "vm.overcommit_memory = 1" > /etc/sysctl.d/overcommit.conf
systemctl enable redis.service

pacman -S nginx
mkdir -p /etc/nginx/sites.d
install -m 644 /tmp/setup/files/nginx.conf /etc/nginx
systemctl enable nginx.service

GEM_HOME=`ruby -rubygems -e "puts Gem.default_dir"` gem install bundler --no-user-install

install -m 644 /tmp/setup/files/unicorn@.service /etc/systemd/system

install -m 644 /tmp/setup/files/resque_workers@.service /etc/systemd/system

sudo -i -u ${SUDO_USER}
cd `mktemp -d`
curl https://aur.archlinux.org/packages/gi/gitolite/gitolite.tar.gz -o - | tar zxf - --strip-components=1
makepkg -s -c -i
exit
mkdir -p /srv/git && chown -R git:git /srv/git && usermod -d /srv/git git
cp /tmp/setup/files/authorized_keys /srv/git/zynaps.pub
sudo -i -u git gitolite setup -pk zynaps.pub
rm /srv/git/zynaps.pub
